<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ReCreate Outfit â€“ CRUD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<header>
    <div class="container">
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="images.html">Images</a></li>
                <li><a href="add-category.html">Add Category</a></li>
                <li><a href="add-json.html">Add JSON</a></li>
                <li><a href="edit-image.html">Edit Image</a></li>
                <li><a href="aicards.html">AI Cards</a></li>
                <li><a href="recreatoutfit.html">Recreate Outfit</a></li>
            </ul>
        </nav>
    </div>
</header>
<body class="bg-gray-100 min-h-screen p-6">
  <div x-data="crud()" x-init="init()">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">ReCreate Outfit Collection</h1>

    <!-- ADD BUTTON -->
    <button @click="openAddModal()"
            class="mb-6 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
      + Add Outfit
    </button>

    <!-- GROUPED VIEW -->
    <div>
      <template x-for="group in groupedItems" :key="group.id">
        <section class="mb-8">
          <h2 class="text-2xl font-semibold text-gray-700 mb-4" x-text="group.id"></h2>

          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <template x-for="item in group.items" :key="item.id">
              <div class="bg-white rounded-xl shadow relative">
                <img :src="item.img.trim()" class="h-60 w-full object-cover rounded-t-xl"
                     onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
                <div class="p-4">
                  <h3 class="font-semibold truncate" x-text="item.title"></h3>
                  <p class="text-blue-600 font-bold">$<span x-text="item.price.toFixed(2)"></span></p>
                  <div class="mt-3 flex gap-2">
                    <button @click="edit(item)"
                            class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button>
                    <button @click="del(item)"
                            class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Delete</button>
                  </div>
                </div>
              </div>
            </template>

            <div x-show="group.items.length === 0" class="text-gray-500 col-span-full">
              No outfits in this category yet.
            </div>
          </div>
        </section>
      </template>
    </div>

    <!-- MODAL -->
    <div x-show="showModal" x-transition class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
      <div class="bg-white rounded p-6 w-full max-w-sm">
        <h2 class="text-xl font-bold mb-4" x-text="isEdit ? 'Edit Outfit' : 'Add Outfit'"></h2>
        <form @submit.prevent="save()">
          <label class="block mb-2 text-sm font-medium">Category</label>
          <select x-model="form.groupId" required class="w-full border px-3 py-2 rounded mb-3">
            <option value="">-- choose --</option>
            <template x-for="cat in categories" :key="cat">
              <option :value="cat" x-text="cat"></option>
            </template>
          </select>

          <label class="block mb-2 text-sm font-medium">Title</label>
          <input x-model="form.title" required class="w-full border px-3 py-2 rounded mb-3">

          <label class="block mb-2 text-sm font-medium">Image URL</label>
          <input x-model="form.img" required class="w-full border px-3 py-2 rounded mb-3">

          <label class="block mb-2 text-sm font-medium">Price</label>
          <input type="number" step="0.01" x-model.number="form.price" required class="w-full border px-3 py-2 rounded mb-3">

          <label class="block mb-2 text-sm font-medium">Link</label>
          <input x-model="form.url" class="w-full border px-3 py-2 rounded mb-4">

          <label class="flex items-center mb-4">
            <input type="checkbox" x-model="form.isNew" class="mr-2"> Mark as NEW
          </label>

          <div class="flex justify-end gap-2">
            <button type="button" @click="closeModal()" class="text-gray-600 px-4 py-2 rounded">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  function crud() {
    return {
      groupedItems: [],
      categories: [],
      showModal: false,
      isEdit: false,
      form: { id:'', groupId:'', title:'', img:'', price:0, url:'', isNew:false },

      async init() {
        await this.load();
        this.categories = this.groupedItems.map(g => g.id);
      },

      async load() {
        const res = await fetch('/api/recreate');
        const groups = await res.json();
        this.groupedItems = groups.map(g => ({
          id: g.id,
          items: (g.items || []).map(i => ({...i, groupId: g.id}))
        }));
      },

      openAddModal() {
        this.isEdit = false;
        this.form = { id:'', groupId:'', title:'', img:'', price:0, url:'', isNew:false };
        this.showModal = true;
      },

      edit(item) {
        this.isEdit = true;
        this.form = {...item};
        this.showModal = true;
      },

      closeModal() { this.showModal = false; },

      async save() {
        const {id, ...payload} = this.form;
        const method = this.isEdit ? 'PUT' : 'POST';
        const url = this.isEdit
          ? `/api/recreate/${this.form.groupId}/items/${this.form.id}`
          : `/api/recreate/${this.form.groupId}/items`;

        const res = await fetch(url, {
          method,
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          this.closeModal();
          await this.load();
          this.categories = this.groupedItems.map(g => g.id);
        } else {
          const msg = await res.text();
          alert('Save failed: ' + msg);
        }
      },

      async del(item) {
        if (!confirm('Delete this outfit?')) return;
        const res = await fetch(`/api/recreate/${item.groupId}/items/${item.id}`, {method: 'DELETE'});
        if (res.ok) {
          await this.load();
          this.categories = this.groupedItems.map(g => g.id);
        } else {
          alert('Delete failed');
        }
      }
    }
  }
  </script>
</body>
</html>